<p><a href="https://medium.com/handlebar-labs/graphql-authentication-with-react-native-apollo-part-2-2-13ac8c362113">참고자료</a></p>

<h2 id="전체코드">전체코드</h2>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">makeExecutableSchema</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">graphql-tools</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">MongoClient</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">mongodb</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">TEMP_USER</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">_id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">spencer@handlebarlabs.com</span><span class="dl">"</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="s2">`
  type User {
    _id: String
    email: String
  }
  type Query {
    currentUser: User
  }
  type Mutation {
    login(email: String!, password: String!): User
    signUp(email: String!, password: String!): User
  }
`</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">Query</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">currentUser</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">TEMP_USER</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">login</span><span class="p">:</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">passwrod</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">TEMP_USER</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="na">signup</span><span class="p">:</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">mongo</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">TEMP_USER</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Required: Export the GraphQL.js schema object as "schema"</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">makeExecutableSchema</span><span class="p">({</span>
  <span class="nx">typeDefs</span><span class="p">,</span>
  <span class="nx">resolvers</span>
<span class="p">});</span>

<span class="c1">// Optional: Export a function to get context from the request.</span>

<span class="kd">let</span> <span class="nx">mongo</span><span class="p">;</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">context</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">secrets</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mongo</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mongo</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">secrets</span><span class="p">.</span><span class="nx">MONGO_URL</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">headers</span><span class="p">,</span>
    <span class="nx">secrets</span><span class="p">,</span>
    <span class="nx">mongo</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="connecting-to-thedatabase">Connecting to the Database</h2>

<p>Once you’ve set up your account with <a href="https://mlab.com">mLab</a> and created a new mongo db instance you should see a url along the lines of</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mongodb://&lt;dbuser&gt;:&lt;dbpassword&gt;@ds121665.mlab.com:21665/graphql-auth-demo-1
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 나의경우
mongodb://shiftcard:1234@ds121665.mlab.com:21665/graphql-auth-demo-1
</code></pre></div></div>

<p><code class="highlighter-rouge">launchpad apollo의 key에 MONGO_URL, value값에 위의 값 추가함</code></p>

<p>you’ll also need to create a user for that database (with write permissions). Take that url and add it to our “secrets” as <code class="highlighter-rouge">MONGO_URL</code> in Launchpad. Make sure to swap out <code class="highlighter-rouge">&lt;dbuser&gt;</code> and <code class="highlighter-rouge">&lt;dbpassword&gt;</code> with the values of the user you created.</p>

<p>By adding the secret values here we can access them from our context function, which is where we’ll be establishing our mongo connection. This context function will be called each time a request is made to a GraphQL endpoint so we want to store a reference to our connection outside of the function (allowing us to only make the db connection request once). We’ll then return the mongo variable in context so that we access it in our resolver functions.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">mongo</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">client</span><span class="p">;</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">context</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">secrets</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mongo</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">client</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">secrets</span><span class="p">.</span><span class="nx">MONGO_URL</span><span class="p">);</span>
    <span class="nx">mongo</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="dl">"</span><span class="s2">graphql-auth-demo-1</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">headers</span><span class="p">,</span>
    <span class="nx">secrets</span><span class="p">,</span>
    <span class="nx">mongo</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Make sure you <code class="highlighter-rouge">import { MongoClient } from 'mongodb';</code> at the top of your file! Launchpad will automatically install it.</p>

<h2 id="sign-up">Sign Up</h2>

<p>Now let’s access the database from the resolver functions… first signup. We’ll get a reference to a <code class="highlighter-rouge">users</code> collection and then check if a user with the given email address already exists.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="na">signup</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">mongo</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">existingUser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">existingUser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Email already used</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// TODO: Make this real</span>
      <span class="k">return</span> <span class="nx">TEMP_USER</span><span class="p">;</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>We can then insert the user document into the collection. I’ll be using <code class="highlighter-rouge">bcrypt</code> to hash the user’s password, because you should never store a plain text password in your database! Make sure you import the lib:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">bcrypt</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">bcrypt</span><span class="dl">"</span><span class="p">;</span>
</code></pre></div></div>

<p>I’m going to be using async/await because it makes for easy to follow code.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="na">signup</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">mongo</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">existingUser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">existingUser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Email already used</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
        <span class="nx">email</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="nx">hash</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>

      <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Go ahead and give it a shot in Launchpad</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">mutation</span> <span class="p">{</span>
  <span class="nx">signup</span><span class="p">(</span><span class="nx">email</span><span class="p">:</span><span class="dl">"</span><span class="s2">c@test.com</span><span class="dl">"</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span><span class="dl">"</span><span class="s2">password</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_id</span>
    <span class="nx">email</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="login">Login</h2>

<p>The login mutation is very similar to the one we just put together.</p>

<p>First we’ll check if a user with that email address exists.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">login</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">mongo</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">);</span>

      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Email not found</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">...</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Then we’ll compare the password supplied and the password we have stored. If they match then return the user!</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">login</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">mongo</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">);</span>

      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Email not found</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">const</span> <span class="nx">validPassword</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">validPassword</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password is incorrect</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="p">...</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>So now we’ve got our sign in &amp; sign up mutations working, but that isn’t all! We don’t want to force the user to have to login with every request. Enter…</p>

<h2 id="json-webtokens">JSON Web Tokens</h2>

<blockquote>
  <p>JSON Web Token (JWT) is an open standard (<a href="https://tools.ietf.org/html/rfc7519">RFC 7519</a>) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be verified and trusted because it is digitally signed. JWTs can be signed using a secret (with the <strong>HMAC</strong> algorithm) or a public/private key pair using <strong>RSA</strong>.</p>
</blockquote>

<p>For us this means that we can generate a JWT and use that as a means of confidently identifying a user. The flow will work like this</p>

<ol>
  <li>User logs in or signs up</li>
  <li>The server returns a JWT</li>
  <li>The client saves the JWT to their local storage (covered in part 2)</li>
  <li>The JWT is passed with each request from client to server (on the <code class="highlighter-rouge">Authorization</code> header — covered in part 2)</li>
  <li>The server uses the JWT to grab the user’s information and add it to <code class="highlighter-rouge">context</code></li>
</ol>

<blockquote>
  <p>A note on step 5: Since I wanted to keep this all browser based we need to do this manually. If you’ve got total control over the server though you can use <code class="highlighter-rouge">[express-jwt](https://www.npmjs.com/package/express-jwt)</code> to do this automatically. This is a good way to learn what that module is doing though!</p>
</blockquote>

<h3 id="the-secret">The Secret</h3>

<p>A JWT is signed with a secret value. We’ll want to come up with one and add that to the “Secrets” in Launchpad, like we did <code class="highlighter-rouge">MONGO_URL</code>. I’m storing it as <code class="highlighter-rouge">JWT_SECRET</code> with a value of <code class="highlighter-rouge">super-secret</code>.</p>

<p><code class="highlighter-rouge">launchpad apollo의 key값에 JWT_SCRET과 value값에 super-secret 추가함</code></p>

<p>Now, using that secret we’ll want to generate a new JWT and return it on the user object when they successfully login or sign up. First I’ll add <code class="highlighter-rouge">jwt</code> to the <code class="highlighter-rouge">User</code>type in our type definitions.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="p">...</span>

<span class="kd">const</span> <span class="nx">typeDefs</span> <span class="o">=</span> <span class="s2">`
  type User {
    _id: String
    email: String
    jwt: String
  }
  type Query {
    currentUser: User
  }
  type Mutation {
    login(email: String!, password: String!): User
    signup(email: String!, password: String!): User
  }
`</span><span class="p">;</span>

<span class="p">...</span>
</code></pre></div></div>

<p>Make sure you add import jwt from ‘jsonwebtoken’; to the top of your file.</p>

<h2 id="generating-the-token">Generating the Token</h2>

<p>Then, upon successful login, I’ll create a JWT. We’re passing the user’s id as part of the payload and secrets is coming from context.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">login</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">mongo</span><span class="p">,</span> <span class="nx">secrets</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">);</span>

      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Email not found</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">const</span> <span class="nx">validPassword</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">validPassword</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password is incorrect</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Generate the jwt and add it to the user document being returned.</span>
      <span class="nx">user</span><span class="p">.</span><span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span> <span class="p">},</span> <span class="nx">secrets</span><span class="p">.</span><span class="nx">JWT_SECRET</span><span class="p">);</span>

      <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="p">...</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>We’ll do the same for sign up.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="na">signup</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">mongo</span><span class="p">,</span> <span class="nx">secrets</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">existingUser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">existingUser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Email already used</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
        <span class="nx">email</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="nx">hash</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>

      <span class="nx">user</span><span class="p">.</span><span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span> <span class="p">},</span> <span class="nx">secrets</span><span class="p">.</span><span class="nx">JWT_SECRET</span><span class="p">);</span>

      <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="adding-the-current-user-to-context">Adding the Current User to Context</h2>

<p>Finally (for this part at least) we need to add the current user to context.</p>

<p>Remember, if you’re not using Launchpad you can use express-jwt to do this automatically. I also need to note that I’m basing this function a bit off of this launchpad which does the same thing but for the Auth0 service.</p>

<p>First, create a new function called getUser and check if we’ve got a potentially valid authorization token in the header.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">getUser</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">authorization</span><span class="p">,</span> <span class="nx">secrets</span><span class="p">,</span> <span class="nx">mongo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">bearerLength</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Bearer </span><span class="dl">"</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">authorization</span> <span class="o">&amp;&amp;</span> <span class="nx">authorization</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">bearerLength</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Then we’ll try to verify the token that was passed.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">getUser</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">authorization</span><span class="p">,</span> <span class="nx">secrets</span><span class="p">,</span> <span class="nx">mongo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">bearerLength</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Bearer </span><span class="dl">"</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">authorization</span> <span class="o">&amp;&amp;</span> <span class="nx">authorization</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">bearerLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">authorization</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">bearerLength</span><span class="p">);</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">ok</span><span class="p">,</span> <span class="nx">result</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span>
      <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">secrets</span><span class="p">.</span><span class="nx">JWT_SECRET</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">({</span>
            <span class="na">ok</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="na">result</span><span class="p">:</span> <span class="nx">err</span>
          <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">({</span>
            <span class="na">ok</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">result</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">mongo</span>
        <span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Then we’ll attempt to fetch the user from our database using the _id that we put into the jwt payload initially. ObjectId is coming from the mongdb module.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">getUser</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">authorization</span><span class="p">,</span> <span class="nx">secrets</span><span class="p">,</span> <span class="nx">mongo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">bearerLength</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Bearer </span><span class="dl">"</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">authorization</span> <span class="o">&amp;&amp;</span> <span class="nx">authorization</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">bearerLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">authorization</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">bearerLength</span><span class="p">);</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">ok</span><span class="p">,</span> <span class="nx">result</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span>
      <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">secrets</span><span class="p">.</span><span class="nx">JWT_SECRET</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">({</span>
            <span class="na">ok</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="na">result</span><span class="p">:</span> <span class="nx">err</span>
          <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">({</span>
            <span class="na">ok</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">result</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">mongo</span>
        <span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Finally, let’s go ahead and call this getUser function from the context function.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">context</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">secrets</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mongo</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">client</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">secrets</span><span class="p">.</span><span class="nx">MONGO_URL</span><span class="p">);</span>
    <span class="nx">mongo</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="dl">"</span><span class="s2">graphql-auth-demo-1</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="dl">"</span><span class="s2">authorization</span><span class="dl">"</span><span class="p">],</span> <span class="nx">secrets</span><span class="p">,</span> <span class="nx">mongo</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">headers</span><span class="p">,</span>
    <span class="nx">secrets</span><span class="p">,</span>
    <span class="nx">mongo</span><span class="p">,</span>
    <span class="nx">user</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can also update the <code class="highlighter-rouge">currentUser</code> query to return the user from context.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">Query</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">currentUser</span><span class="p">:</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Let’s go ahead and check this out…</p>

<p>And there you have it! Runnable source code is available below</p>
